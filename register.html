<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>IT Vault - Registration</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #2c3e50; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .reg-card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); width: 100%; max-width: 400px; text-align: center; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #2ecc71; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        button:hover { background: #27ae60; }
        #tfaSection { display: none; margin-top: 20px; padding-top: 20px; border-top: 2px solid #f1f2f6; }
        .qr-code { margin: 15px 0; border: 1px solid #eee; padding: 10px; border-radius: 10px; }
        .step { font-size: 14px; color: #7f8c8d; margin-bottom: 10px; font-weight: bold; }
        .error { color: #e74c3c; font-size: 14px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="reg-card">
    <h2>יצירת חשבון מנהל 🔑</h2>
    
    <div id="step1">
        <div class="step">שלב 1: פרטי גישה</div>
        <input type="text" id="username" placeholder="שם משתמש">
        <input type="password" id="password" placeholder="סיסמה חדשה">
        <button onclick="showTFA()">המשך להגדרת אבטחה</button>
    </div>

    <div id="tfaSection">
        <div class="step">שלב 2: סריקת קוד 2FA</div>
        <p style="font-size: 13px;">סרוק את הקוד ב-Google Authenticator:</p>
        <div id="qrContainer" class="qr-code"></div>
        <p style="font-size: 12px; color: #95a5a6;">מפתח סודי ידני: <span id="secretLabel" style="font-family: monospace; font-weight: bold;"></span></p>
        
        <input type="text" id="otp_verify" placeholder="הכנס קוד מהאפליקציה (6 ספרות)" maxlength="6" style="text-align: center; letter-spacing: 5px;">
        <button onclick="handleRegister()">סיום הרשמה והפעלה</button>
    </div>

    <div id="errorMsg" class="error"></div>
    <p style="margin-top: 20px; font-size: 13px;"><a href="login.html" style="color: #3498db; text-decoration: none;">כבר יש לי חשבון? התחבר כאן</a></p>
</div>

<script>
    let generatedSecret = "";

    // ייצור מפתח סודי (Base32)
    function generateSecret() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
        let secret = '';
        for (let i = 0; i < 16; i++) secret += chars.charAt(Math.floor(Math.random() * chars.length));
        return secret;
    }

    function showTFA() {
        const user = document.getElementById('username').value;
        const pass = document.getElementById('password').value;

        if (user.length < 3 || pass.length < 6) {
            alert("שם משתמש (מינימום 3) או סיסמה (מינימום 6) קצרים מדי");
            return;
        }

        generatedSecret = generateSecret();
        document.getElementById('secretLabel').innerText = generatedSecret;
        
        // יצירת קוד QR
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?data=otpauth://totp/IT_Vault:${user}?secret=${generatedSecret}&issuer=IT_Vault&size=180x180`;
        document.getElementById('qrContainer').innerHTML = `<img src="${qrUrl}" alt="QR Code">`;
        
        document.getElementById('step1').style.display = 'none';
        document.getElementById('tfaSection').style.display = 'block';
    }

    async function handleRegister() {
        const user = document.getElementById('username').value;
        const pass = document.getElementById('password').value;
        const otp = document.getElementById('otp_verify').value;
        const errorMsg = document.getElementById('errorMsg');

        if (otp.length !== 6) {
            errorMsg.innerText = "חובה להזין קוד אימות תקין מהאפליקציה";
            return;
        }

        try {
            // שים לב: אנחנו שולחים את ה-Secret (כדי לשמור אותו ב-DB) ואת ה-OTP (כדי שהשרת יאמת אותו מיד)
            const response = await fetch('db.php?action=register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    username: user, 
                    password: pass, 
                    tfa: generatedSecret,
                    otp: otp // לצורך אימות ראשוני בהרשמה
                })
            });

            const result = await response.json();

            if (result.status === "success") {
                alert("ההרשמה הצליחה! המערכת מאובטחת כעת ב-2FA.");
                window.location.href = "login.html";
            } else {
                errorMsg.innerText = result.message || "שגיאה בתהליך ההרשמה";
            }
        } catch (e) {
            errorMsg.innerText = "שגיאה בחיבור לשרת";
        }
    }
</script>

</body>
</html>